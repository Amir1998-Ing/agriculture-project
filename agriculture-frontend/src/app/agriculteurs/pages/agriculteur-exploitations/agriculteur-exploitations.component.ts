import { Component, Input, OnInit, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { AgriculteurService } from '../../../core/services/agriculteur.service';
import { Exploitation, ExploitationRequest } from '../../../core/models/agriculteur.model';

@Component({
  selector: 'app-agriculteur-exploitations',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './agriculteur-exploitations.component.html',
  styleUrls: ['./agriculteur-exploitations.component.css']
})
export class AgriculteurExploitationsComponent implements OnInit {
  @Input() agriculteurId!: number;
  private service = inject(AgriculteurService);

  exploitations: Exploitation[] = [];
  newExploitation: Partial<ExploitationRequest> = { nom: '', superficie: 0, localisation: '', type: '' };
  loading = false;
  error = '';

  ngOnInit(): void {
    if (this.agriculteurId) this.load();
  }

  load(): void {
    this.loading = true;
    this.service.getExploitationsByAgriculteur(this.agriculteurId).subscribe({
      next: (list) => { this.exploitations = list; this.loading = false; },
      error: (err) => { console.error(err); this.error = 'Erreur chargement exploitations'; this.loading = false; }
    });
  }

  add(): void {
    this.error = '';
    if (!this.newExploitation.nom) { this.error = 'Nom requis'; return; }
    this.service.createExploitation(this.agriculteurId, this.newExploitation as ExploitationRequest).subscribe({
      next: (e) => { this.exploitations.push(e); this.newExploitation = { nom: '', superficie: 0, localisation: '', type: '' }; },
      error: (err) => { console.error(err); this.error = 'Erreur cr√©ation'; }
    });
  }
}
